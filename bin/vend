#!/usr/bin/env php
<?php

require_once __DIR__ . '/../lib/autoload.php';

if (!function_exists('pcntl_signal')) {
    die("PCNTL support seems to be missing or disabled. See https://github.com/d11wtq/boris/issues/29 for details\n");
}

if (count($argv) <> 2) {
    echo 'Need to provide an App ID (e.g. Sigma) as CLI argument when running vend' . PHP_EOL;
    exit(0);
}

$appId = $argv[1];
$prompt = 'vend on ' . gethostname() . ' using ' . $appId . ' > ';

$boris = new \Boris\Boris($prompt);

//$boris->onStart('echo "The date is $date\n";');
$onStartLines = array(
    "error_reporting(E_ALL);",
//    "register_shutdown_function('nice_php_shutdown');",

//    'define(\'DOCNET_APP_ID\', !empty($_SERVER[\'DEFAULT_APP_ID\']) ? $_SERVER[\'DEFAULT_APP_ID\'] : \'Central\');',
    'define(\'DOCNET_APP_ID\', \'' . $appId . '\');',
//    'define(\'DOCNET_APP_ID\', \'Sigma\');',
    "require_once('/app/vc-local/custom/admin_html/_shared.php');",
    "require_once('/app/vc-local/custom/config/base-config.php');",
    "require_once('/app/vc-local/custom/config/app_and_db.php');",

//    "Init::init_admin_index();",
//    "SprintRegistry::get()->get_uow()->commit();",
);

foreach ($onStartLines as $onStartLine) {
    $boris->onStart($onStartLine);
}

$boris->onStart(function($worker, $vars){
    $worker->setLocal('_c', \DataFactory::get_sprint_3c_searcher());
    $worker->setLocal('_i', \DataFactory::get_inventory_searcher());
});

$_SERVER['REMOTE_ADDR'] = '127.0.0.1';
$_SERVER['REQUEST_URI'] = '/';
$boris->setLocal('$_SERVER', array(
    'REMOTE_ADDR' => '127.0.0.1',
    'REQUEST_URI' => '/',
));
$boris->onStart(function($worker, $vars){
    $worker->setLocal('$_SERVER', array(
        'REMOTE_ADDR' => '127.0.0.1',
        'REQUEST_URI' => '/',
    ));
});

$boris->setInspector(new \Vend\VenditanCommerceOutputInspector);

$config = new \Boris\Config();
$config->apply($boris);

$options = new \Boris\CLIOptionsHandler();
$options->handle($boris);

$boris->start();
